name: Kubernetes Manifest Validation

on:
  pull_request:
    paths:
      - "Chart.yaml"
      - "values.yaml"
      - "templates/**"
      - ".github/workflows/k8s-validate.yml"
  workflow_call:

jobs:
  validate:
    name: Validate Rendered Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Render and Validate Manifests
        run: |
          # Render templates and validate YAML syntax
          # Helm template already validates chart structure and template syntax
          # We'll also validate the rendered YAML is parseable
          set -e

          echo "Rendering Helm templates..."
          helm template test-release . > /tmp/rendered.yaml

          # Validate YAML syntax using yq (if available) or basic checks
          if command -v yq &> /dev/null; then
            echo "Validating YAML with yq..."
            yq eval-all '. as $item ireduce ({}; . * $item)' /tmp/rendered.yaml > /dev/null
          else
            # Basic validation - check for YAML document separators and structure
            echo "Validating YAML structure..."
            if ! grep -q "^apiVersion:" /tmp/rendered.yaml && ! grep -q "^kind:" /tmp/rendered.yaml; then
              echo "⚠️ Warning: No Kubernetes resources found in rendered output"
            fi
          fi

          echo "✅ All manifests rendered successfully"
          echo "Rendered $(grep -c '^---' /tmp/rendered.yaml || echo 0) YAML documents"
